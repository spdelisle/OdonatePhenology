data exp;
input fam $	Room $ Treatment tank $ emerge	sex $;
if Treatment = 24 then trt = 'hot';
if Treatment = 20 then trt = 'cold';
datalines;
AJ	B	24	26	58	F
AX	B	24	24	61	F
BN	B	24	19	61	F
AX	B	24	17	67	F
AT	C	24	48	70	F
I	B	24	14	81	F
AI	C	24	54	74	F
V	C	24	44	81	F
AY	C	24	43	75	F
BM	C	24	43	76	F
AT	C	24	38	79	F
O	C	24	48	89	F
AA	C	24	33	91	F
AT	C	24	34	85	F
BH	C	24	46	92	F
BI	C	24	44	92	F
BH	C	24	33	93	F
CG	B	24	32	94	F
A	C	24	54	112	F
BC	A	24	3	102	F
BE	C	24	59	102	F
CC	A	24	1	100	F
DF	C	24	43	85	F
AW	C	24	50	105	F
BE	C	24	54	107	F
AK	B	24	14	111	F
AM	B	24	26	110	F
AA	C	24	53	118	F
DD	C	24	44	98	F
AN	B	24	17	118	F
CT	B	24	27	108	F
AV	B	24	17	120	F
BH	B	24	21	122	F
BD	B	24	26	123	F
AZ	B	24	19	127	F
BK	B	24	17	127	F
BE	B	24	32	129	F
CR	B	24	27	119	F
C	B	20	15	146	F
CA	A	24	5	134	F
BE	B	24	26	141	F
BE	B	24	21	148	F
BV	B	24	32	147	F
CX	B	24	26	133	F
AN	A	24	3	152	F
BS	B	24	26	151	F
BB	C	24	43	154	F
CL	B	24	17	153	F
DI	B	24	21	141	F
BV	B	24	27	158	F
CR	B	24	32	156	F
AH	C	24	46	169	F
CZ	C	24	34	150	F
CK	B	24	14	165	F
BC	B	24	26	170	F
CZ	B	24	14	153	F
DA	B	24	14	153	F
AE	B	24	31	177	F
AE	B	24	32	177	F
BB	A	24	5	173	F
BG	B	24	19	173	F
CT	B	24	17	163	F
AE	A	20	10	180	F
AW	A	24	4	175	F
AM	A	24	5	178	F
AW	B	24	31	178	F
BL	B	20	30	179	F
AC	A	24	5	187	F
AX	B	24	19	181	F
AN	C	24	34	183	F
BX	B	24	27	180	F
CC	A	24	5	180	F
BA	A	24	4	184	F
BC	B	24	17	184	F
BD	A	24	7	184	F
AI	B	20	30	187	F
BG	B	24	17	185	F
BZ	C	24	43	183	F
AN	A	24	5	187	F
BA	A	24	5	186	F
CP	A	24	12	180	F
AX	B	24	29	188	F
CE	B	24	32	184	F
CY	A	24	5	170	F
AC	B	20	23	195	F
AR	A	24	12	189	F
AB	B	24	27	196	F
AY	A	20	9	190	F
BV	B	24	17	188	F
BX	B	24	17	188	F
AB	A	20	9	200	F
BZ	B	24	17	191	F
CE	C	24	47	190	F
CH	C	24	33	190	F
AM	B	24	32	195	F
AR	A	20	9	196	F
BE	B	20	30	195	F
CH	C	24	34	192	F
AQ	B	24	32	197	F
BC	B	24	14	196	F
BV	A	20	9	195	F
BL	B	24	29	199	F
CA	B	24	32	197	F
N	B	24	17	211	F
CA	B	20	23	201	F
CY	B	24	27	187	F
BG	A	24	12	205	F
AT	C	24	37	207	F
Z	C	24	34	215	F
DC	C	24	33	190	F
AM	C	24	54	211	F
CA	C	24	46	208	F
DI	A	24	4	192	F
BB	B	24	24	211	F
BW	A	24	1	208	F
AC	A	24	7	220	F
AE	C	24	46	219	F
BS	C	24	37	212	F
BG	A	24	1	215	F
BX	A	24	5	214	F
CN	B	24	21	213	F
CB	B	24	14	217	F
BI	A	20	11	220	F
I	B	24	27	230	F
BW	B	24	21	217	F
DH	B	24	27	203	F
CA	B	24	29	220	F
Z	C	20	49	230	F
AV	A	20	8	224	F
BJ	C	24	53	223	F
CM	A	24	7	220	F
DI	A	24	3	207	F
AZ	B	20	22	229	F
CJ	B	24	29	225	F
AK	B	24	17	232	F
BH	B	24	17	230	F
CI	A	24	1	228	F
BR	A	24	1	231	F
AR	C	20	49	235	F
DI	A	20	9	217	F
BN	A	20	11	236	F
CE	B	24	21	234	F
AW	A	24	7	239	F
CQ	B	24	29	230	F
BW	B	24	29	236	F
CG	B	24	17	237	F
BM	A	24	7	244	F
DO	B	24	19	226	F
AG	B	20	25	251	F
BF	A	24	12	250	F
CX	B	24	32	235	F
BI	C	24	37	255	F
AB	B	20	30	263	F
AR	C	24	33	258	F
BE	C	24	38	257	F
BL	B	24	31	257	F
BH	A	24	7	259	F
N	B	20	13	268	F
CE	B	24	31	257	F
CY	B	24	31	244	F
M	A	20	11	271	F
V	B	24	24	269	F
CH	B	24	17	259	F
AL	A	24	12	266	F
BP	C	20	45	263	F
BV	A	20	8	262	F
CJ	B	24	14	260	F
AB	C	20	49	273	F
AY	C	20	36	267	F
BT	B	24	21	265	F
DC	A	20	6	253	F
BL	B	24	32	278	F
CM	A	20	9	277	F
AH	C	20	49	287	F
DL	C	24	33	266	F
P	B	24	19	295	F
AA	C	24	54	63	M
AI	C	24	43	58	M
AZ	C	24	44	62	M
BH	C	24	47	62	M
AV	C	24	54	65	M
AB	C	24	50	73	M
BK	C	24	44	66	M
BK	C	24	46	66	M
BM	C	24	47	66	M
Z	C	24	53	74	M
BO	B	24	26	66	M
V	B	24	19	75	M
BB	C	24	48	68	M
BJ	B	24	17	68	M
AV	C	24	38	70	M
BH	C	24	59	69	M
CA	C	24	54	67	M
AI	C	24	46	73	M
AT	C	24	43	72	M
AA	C	24	47	80	M
AY	B	24	17	74	M
CF	C	24	46	70	M
CI	B	24	14	70	M
AW	B	24	21	74	M
AE	C	24	48	82	M
BT	B	24	29	75	M
BZ	C	24	46	76	M
AI	C	24	38	82	M
AI	C	24	59	87	M
AY	B	24	27	89	M
AY	C	24	33	91	M
BD	C	24	46	90	M
AM	C	24	33	93	M
BI	B	24	17	92	M
BY	B	24	14	90	M
AB	A	24	4	101	M
BV	C	24	46	92	M
CI	C	24	33	91	M
BI	B	24	27	95	M
BU	C	24	53	94	M
BM	B	24	17	97	M
CV	C	24	53	86	M
BB	B	24	19	98	M
DM	C	24	53	80	M
DM	C	24	46	81	M
BH	C	24	38	102	M
CW	C	24	53	91	M
DA	C	24	54	91	M
DF	C	24	37	90	M
AT	C	24	53	110	M
BZ	C	24	33	108	M
DD	C	24	34	92	M
Q	C	24	34	119	M
AV	C	20	49	114	M
BG	B	24	27	114	M
DJ	C	24	33	99	M
BA	C	24	59	118	M
BS	B	24	31	117	M
AM	B	24	19	120	M
AQ	B	24	17	121	M
AY	C	20	49	121	M
CG	B	20	20	117	M
BH	B	24	31	121	M
DE	B	24	17	105	M
BS	B	24	19	123	M
BS	B	24	32	124	M
BD	B	24	19	128	M
BG	B	24	26	129	M
BZ	B	20	28	128	M
Z	B	24	29	141	M
CA	B	24	19	134	M
DG	C	24	48	120	M
BS	B	24	27	141	M
BY	B	24	27	140	M
CX	B	24	27	127	M
BZ	B	20	30	145	M
BO	B	24	27	147	M
AR	B	24	27	150	M
BE	B	24	14	149	M
BL	C	24	34	149	M
N	B	24	27	158	M
BL	A	24	5	150	M
BY	B	24	32	148	M
AW	B	24	24	151	M
BJ	B	24	19	153	M
CB	B	24	27	151	M
DD	C	24	46	136	M
BD	C	24	47	160	M
N	B	24	24	170	M
AY	A	24	5	164	M
AF	B	24	24	170	M
DL	C	24	54	149	M
AW	B	24	14	170	M
AY	B	24	32	171	M
CK	B	24	17	166	M
I	C	24	54	180	M
AL	B	20	16	173	M
AX	B	24	31	172	M
BC	A	24	5	171	M
BM	A	24	4	171	M
BU	B	24	19	169	M
I	B	24	31	181	M
BW	B	24	26	171	M
BS	C	24	44	175	M
CH	B	24	14	173	M
BJ	B	24	29	177	M
BG	C	24	54	178	M
CB	A	24	5	176	M
BP	A	24	7	179	M
I	B	20	22	190	M
BM	B	24	14	184	M
BT	A	24	7	183	M
BZ	A	24	7	182	M
M	B	24	19	194	M
BB	A	20	6	185	M
BD	B	24	21	185	M
BP	B	24	24	184	M
BY	A	20	9	183	M
BP	C	24	43	185	M
AG	A	24	5	190	M
AY	B	20	13	188	M
CK	B	24	27	184	M
BF	B	24	29	189	M
BC	A	20	9	192	M
AQ	B	24	14	194	M
AY	A	20	6	194	M
CR	B	24	31	184	M
AJ	B	24	21	197	M
BM	A	20	9	196	M
BB	A	20	9	197	M
BZ	A	20	6	195	M
I	B	24	19	207	M
AI	A	24	12	200	M
BO	B	24	32	197	M
I	B	20	20	208	M
BH	C	24	54	199	M
DF	B	20	15	181	M
AR	B	24	17	201	M
AV	C	24	46	202	M
BB	C	24	37	201	M
CB	A	20	10	199	M
I	C	20	36	211	M
BW	A	24	12	198	M
CZ	A	24	1	185	M
BX	B	24	14	201	M
AM	B	24	31	206	M
AV	B	24	31	206	M
CA	B	24	31	203	M
DN	B	24	17	186	M
CX	B	24	24	189	M
AM	B	24	17	208	M
BC	B	24	31	207	M
CK	B	20	20	203	M
DG	B	24	14	189	M
DM	C	24	47	188	M
BG	C	24	44	208	M
DG	B	24	31	190	M
DM	C	24	48	190	M
AH	C	24	44	212	M
BP	C	24	47	209	M
AM	A	20	9	212	M
AZ	C	20	36	211	M
M	A	24	1	221	M
Z	A	20	2	219	M
CQ	C	24	59	203	M
AB	C	24	37	220	M
AC	C	24	43	220	M
AQ	A	24	5	214	M
AR	C	24	43	214	M
CY	C	24	54	196	M
AG	A	20	9	217	M
BQ	B	24	31	213	M
CV	B	20	16	203	M
BU	B	24	14	213	M
DI	C	24	44	197	M
CG	B	24	14	213	M
CU	A	24	5	205	M
DI	C	24	34	198	M
CB	B	24	17	215	M
AE	A	20	9	224	M
DH	A	24	12	202	M
CE	B	24	19	218	M
I	C	24	43	231	M
CY	B	24	21	205	M
AI	B	20	23	225	M
CB	C	24	59	222	M
AB	A	24	12	232	M
AA	B	24	32	234	M
AI	C	20	56	232	M
BG	A	20	9	230	M
BM	A	20	11	230	M
Q	A	20	10	240	M
AS	B	24	14	233	M
AB	B	24	21	241	M
BY	B	24	21	232	M
CV	B	24	21	223	M
BF	A	20	8	235	M
BG	A	24	5	236	M
Z	A	20	10	244	M
AN	B	24	19	238	M
BZ	C	24	34	237	M
AJ	B	24	31	243	M
BD	A	24	4	242	M
AR	B	20	20	244	M
BF	B	24	21	244	M
AA	C	24	37	252	M
CG	A	20	8	242	M
BL	B	24	21	248	M
BV	B	20	13	246	M
BC	C	20	45	251	M
CW	C	24	33	240	M
DA	B	24	27	237	M
DH	C	24	48	239	M
BG	A	20	10	264	M
BB	C	20	49	265	M
BP	C	24	37	265	M
BW	C	24	47	262	M
AM	B	20	28	270	M
AW	C	24	58	269	M
CW	C	24	37	260	M
CB	C	24	33	270	M
BD	B	24	31	276	M
BN	C	24	58	276	M
V	A	20	6	286	M
BK	A	20	10	285	M
Z	B	20	13	293	M
CB	C	24	53	89	M 
;

proc glimmix data = exp asycov;
class sex tank fam trt;
model emerge = Treatment/s;
random fam ;
random tank;
 covtest 0 .;
 ods output CovParms = covp(drop =  CovParm StdErr);
ods output AsyCov = hessian(drop = Row CovParm); 

proc iml;
use covp;
read all var{Estimate} into ests;
use hessian;
read all into covs;
h2 = (2*ests[1])/(ests[1]+ests[2]+ests[3]);
print h2;
X1 = J(1000000, 1, .);
do i = 1 to 1000000;
est=randnormal(1, ests, covs);
h = (2*est[1])/(est[1]+est[2]+est[3]);
X1[i,1]=h;
end;
create results from X1[colname={"Heretibility"}];
append from X1;
close results;
proc univariate data = results alpha = .05 noprint;
  var Heretibility;
  output out=p_results std = sd  pctlpts=2.5 97.5 pctlpre = h2 pctlname = _lb _ub ;
proc print data = p_results;
proc sgplot data = results;
histogram Heretibility;
 proc sort data = exp;
 by Treatment;
/*
 ods _all_ close; 
    ods listing gpath='C:\Users\Stephen De Lisle\Desktop\PhenologyMacro';

    ods graphics /  reset=all outputfmt=PDF  imagename='IschPlastFig' border = off; 
*/
 proc sgplot data = exp nolegend;
 vbox emerge / group = Treatment;
 yaxis label = "Emergence day" labelattrs =(size = 14 weight = bold);
run;
